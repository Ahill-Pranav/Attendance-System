<!-- templates/faculty.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Faculty Dashboard</title>
  <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
  <div class="dashboard-card">
    <h1>Faculty Dashboard</h1>

    <h2>Generate QR (auto regenerate up to 5 times)</h2>
    <div class="qr-box">
      <img id="qr" src="" alt="QR Code" width="200" height="200">
      <div id="countdown">10</div>
      <div style="margin-top:8px;">
        <button id="forceGen" class="btn btn-primary">Regenerate Now</button>
        <button id="exportCsv" class="btn" style="background:#06b6d4; color:#fff; margin-left:8px;">Export CSV</button>
      </div>
    </div>

    <h2>Select Date</h2>
    <div class="form-inline">
      <input type="date" id="attendance_date" max="{{ today }}">
      <button onclick="loadAttendance()" class="btn btn-primary">Load Attendance</button>
    </div>

    <h2>Attendance by Hour</h2>
    <table>
      <thead>
        <tr><th>Hour</th><th>Student Email</th><th>Timestamp</th></tr>
      </thead>
      <tbody id="attendance_table">
        <!-- filled dynamically -->
      </tbody>
    </table>
  </div>

<script>
let qrCount = 0;
const maxQR = 5;
let currentTimer = null;

function generateQR() {
    fetch('/generate_qr')
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById('countdown').innerText = "Unauthorized";
                return;
            }
            document.getElementById('qr').src = "data:image/png;base64," + data.qr;
            let countdown = data.expires_in || 10;
            document.getElementById('countdown').innerText = countdown + "s";

            if (currentTimer) clearInterval(currentTimer);
            currentTimer = setInterval(() => {
                countdown--;
                document.getElementById('countdown').innerText = (countdown > 0 ? countdown + "s" : "0s");
                if (countdown <= 0) {
                    clearInterval(currentTimer);
                    qrCount++;
                    if (qrCount < maxQR) {
                        // small delay before next generate for smoothness
                        setTimeout(generateQR, 300);
                    } else {
                        document.getElementById('countdown').innerText = "Done";
                    }
                }
            }, 1000);
        }).catch(err => {
            console.error(err);
            document.getElementById('countdown').innerText = "Error";
        });
}

function loadAttendance() {
    const selectedDate = document.getElementById('attendance_date').value;
    const dateParam = selectedDate ? selectedDate : '';
    fetch(`/faculty_attendance?date=${dateParam}`)
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('attendance_table');
            tbody.innerHTML = "";
            data.hours.forEach(h => {
                if (h.students.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${h.hour}</td><td>-</td><td>-</td>`;
                    tbody.appendChild(tr);
                } else {
                    h.students.forEach(s => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${h.hour}</td><td>${s.student_id}</td><td>${s.timestamp}</td>`;
                        tbody.appendChild(tr);
                    });
                }
            });
        });
}

document.getElementById('forceGen')?.addEventListener('click', () => {
    qrCount = 0;
    generateQR();
});
document.getElementById('exportCsv')?.addEventListener('click', () => {
    window.location = '/export_csv';
});

window.addEventListener('DOMContentLoaded', () => {
    // default date to today
    document.getElementById('attendance_date').value = "{{ today }}";
    generateQR();
    loadAttendance();
});
</script>
</body>
</html>
