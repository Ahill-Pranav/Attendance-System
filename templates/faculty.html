<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Faculty Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="text-primary">Faculty Dashboard</h2>
    <p class="text-muted">Manage attendance and track student participation</p>

    <!-- Generate QR -->
    <div class="card shadow-sm p-4 mb-4">
        <h5>Generate Attendance QR</h5>
        <div class="mt-3" id="qrContainer"></div>
        <p id="qrCountdown" class="text-muted mt-2"></p>
    </div>

    <!-- Attendance List -->
    <div class="card shadow-sm p-4">
        <h5>Attendance List</h5>
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Roll No</th>
                    <th>Name</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody id="attendanceTable"></tbody>
        </table>
    </div>
</div>

<script>
    let qrExpiry = 0;

    async function generateQR() {
        try {
            let res = await fetch("/generate_qr");
            let data = await res.json();

            document.getElementById("qrContainer").innerHTML = 
                `<img src="data:image/png;base64,${data.qr}" width="200"/>`;

            // Set QR expiry to 10 seconds
            qrExpiry = 10;  

            // Countdown timer
            const countdownEl = document.getElementById("qrCountdown");
            clearInterval(countdownEl.timer);  // clear previous timer
            countdownEl.timer = setInterval(() => {
                if (qrExpiry > 0) {
                    countdownEl.innerText = `Expires in ${qrExpiry}s`;
                    qrExpiry--;
                } else {
                    countdownEl.innerText = "QR Expired. Refreshing...";
                    clearInterval(countdownEl.timer);
                    generateQR(); // automatically refresh QR
                }
            }, 1000);

        } catch (err) {
            console.error("Error generating QR:", err);
        }
    }

    async function loadAttendance() {
        try {
            let res = await fetch("/attendance_list");
            let students = await res.json();
            let table = "";
            students.forEach(s => {
                table += `<tr><td>${s.id}</td><td>${s.name}</td><td>${s.time}</td></tr>`;
            });
            document.getElementById("attendanceTable").innerHTML = table;
        } catch (err) {
            console.error("Error loading attendance:", err);
        }
    }

    // Initial load
    generateQR();
    loadAttendance();

    // Refresh attendance list every 5 seconds
    setInterval(loadAttendance, 5000);
</script>
</body>
</html>
