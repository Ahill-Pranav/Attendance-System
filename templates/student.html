<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body class="bg-light">
<div class="container py-5">
    <h2 class="text-primary">Student Dashboard</h2>
    <p class="text-muted">Scan the QR code to mark your attendance</p>

    <!-- Attendance Status -->
    <div class="card shadow-sm p-4 mb-4">
        <h5>Attendance Status</h5>
        <p id="attendanceStatus">Not Marked</p>
    </div>

    <!-- QR Scanner -->
    <div class="card shadow-sm p-4">
        <h5>Scan QR</h5>
        <div id="qr-reader" style="width: 100%;"></div>
        <p id="qr-result" class="text-success mt-2"></p>
    </div>
</div>

<script>
    // Check current attendance status
    async function checkStatus() {
        let res = await fetch("/check_attendance");
        let data = await res.json();
        document.getElementById("attendanceStatus").innerText = data.status;
    }
    setInterval(checkStatus, 5000);
    checkStatus();

    // Handle scan success
    function onScanSuccess(decodedText, decodedResult) {
        document.getElementById("qr-result").innerText = "QR Scanned! Sending attendance...";
        
        fetch("/scan_qr", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: decodedText })
        })
        .then(res => res.json())
        .then(data => {
            document.getElementById("qr-result").innerText = data.msg;
            checkStatus(); // refresh status
        });
    }

    function onScanFailure(error) {
        // Optional: log errors silently
        // console.warn(error);
    }

    // Use the higher-level Scanner Widget (better UX)
    let html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader", 
        { fps: 10, qrbox: { width: 250, height: 250 } }, 
        false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
</script>
</body>
</html>
